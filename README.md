# Streamlined effort application

The goal of this application is to make it as easy as possible for each person
to enter their daily work on various projects, exposing data to downstream
tools. It was originally developed for the [Bioinformatics
and Scientific Programming Core](https://bioinformatics.nichd.nih.gov) but
generalized for
wider use.

It is implemented as a Flask app running in a Docker container.

**Quickstart** (once configured):

- `./build-and-run` to (re)build the container and run it
- `./stop` to bring down the server and container

The app will then be available on `localhost:3536`. Use the "Add entry" button
to add new entries; the home page will plot entries, with colors/filtering
configurable by dropdown and radio buttons, as well as a table.

Get a CSV of the database with from `localhost:3536/csv`.

The app's database will be found in the current directory, `app.db`, and will
be persistent across containers. Configure this in `app/.env` using the
variable `HOST_DATABASE_DIR`.

## Configuration

- **`app/.env`** contains the configuration. This file is sourced by the
  wrapper scripts above as well as in the app config (in `app/config.py`).
- If you want to use LDAP (and know the relevant settings), you can set
  `DISABLE_LDAP=0` and fill in the LDAP-related env vars.
- `app/personnel.yaml` is a YAML file containing a simple list of users
- `app/projects.yaml` is a YAML file representing a dictionary, where keys are
  top-level grouping (here, PIs or labs in the context of projects for
  a bioinformatics core), and values are lists of projects under that grouping.

## Administration

Here, `$NAME` is set by the `DOCKER_CONTAINER` variable in `app/.env`, which by
default is `effort-app`.

- `docker logs $NAME -f` for logs
- `docker exec -it $NAME /bin/bash` to interactively inspect running container

## Notes on architecture

The code is heavily inspired by the *excellent* [Flask Mega-Tutorial
series](https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world).
Here's a brief guide to the moving parts.

### Config

- `app/config.py` reads in the YAML files below and sets up the location of the
  database. It uses `dotenv` to source `app/.env` variables into the
  environment.

- `app/personnel.yaml` is a simple list of people. It is used to populate
  dropdowns in the app.

- `app/projects.yaml` lists the labs and projects in each lab. It is used to
  populate other dropdowns.

- `app/migrations` contains the code for migrating database schemas between
  versions. This is generated by `flask db migrate` and the resulting code is
  applies with `flask db upgrade`. It should not be edited manually. These
  commands are run each time the docker container is started by
  `app/prestart.sh`.


### Code

- `app/app/main.py` is imported and called from `uwsgi.ini` (module is
  `app.main`; callable is `app`).

- `app/app/__init__.py` sets up the db and defines the `create_app()` function.
  **Note that the imports and order of everything in here is carefully
  crafted,** as outlined in the tutorial referenced above.

- `app/app/routes.py` is the "traditional" Flask routes module, which
  determines which functions run when which URLs are visted.

- `app/app/forms.py` defines the main `EffortForm`, the login form, and some
  validators.

- `app/app/models.py` defines the main `Entry` object which is stored in the db

### Templates, CSS, JavaScript

Templates use the Flask-Bootstrap template. Note that this package currently
uses a slightly out-of-date version of the Bootstrap framework.

- `app/app/templates/base.html` defines the base page that other templates
  inherit from. JQuery and DataTables are imported here (used for displaying
  the entries)

- `app/app/templates/entry.html` is the entry page with the form. This one gets
  a little complicated in that there is JavaScript to auto-populate the
  dropdowns of the form. This is so that the "projects" dropdown only shows the
  projects for the selected lab, to simplify the entry process. It also does
  some fancy things with checking the total time entered for the day.

- `app/app/templates/help.html` is the static help page, manually edited.

- `app/app/templates/changelog.html` is the static changelog, manually edited

- `app/app/templates/index.html` is the main page that renders the DataTable
  from the db.

### Docker-specific details

The Docker container builds from the
[`uwsgi-nginx-flask`](https://github.com/tiangolo/uwsgi-nginx-flask-docker),
Docker container which has some nice docs.

The build process copies the entire app directory into the container.

- `Dockerfile` is used to define the Docker container

- `app/uwsgi.ini` configures the uWSGI instance running in the Docker
  container. **Its location and filename are expected by the Dockerfile.**

- `app/prestart.sh` is used by the uwsgi-nginx-flask Docker container's startup
  script. If this specially-named file is in the app directory, it will be run
  before starting the app.

- `stop` is a helper to stop the container

- `build-and-run` builds the container and runs it immediately in daemon mode
